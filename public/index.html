<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRM Query Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 80px; }
    button { margin: 5px; padding: 8px 12px; }
    #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
    .photo-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .photo-grid img { max-width: 200px; border-radius: 8px; }
    .sql-box { background: #f8f8f8; padding: 10px; margin-top: 10px; border: 1px solid #ddd; font-family: monospace; }
  </style>
</head>
<body>
  <h1>CRM Query Assistant</h1>

  <textarea id="question" placeholder="Ask a question..."></textarea><br>
  <button onclick="askQuestion()">Ask</button>
  <button onclick="runSystemTest()">Run System Test</button>

  <div id="result"></div>

  <script>
    async function askQuestion() {
      const q = document.getElementById("question").value;
      if (!q) return alert("Enter a question");

      const resDiv = document.getElementById("result");
      resDiv.innerHTML = "Loading...";

      try {
        const resp = await fetch("/api/query", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ question: q })
        });
        const data = await resp.json();

        if (data.error) {
          resDiv.innerHTML = "<b>Error:</b> " + data.error;
          return;
        }

        let html = `<p><b>Answer:</b> ${data.answer}</p>`;
        html += `<p><b>Query Type:</b> ${data.query_type}</p>`;
        if (data.sql) {
          html += `<div class="sql-box"><b>Generated SQL:</b><br>${data.sql}</div>`;
        }

        if (data.query_type === "airtable") {
          html += createPhotoGrid(data.raw_results);
        } else {
          html += createTable(data.raw_results);
        }

        resDiv.innerHTML = html;
      } catch (e) {
        resDiv.innerHTML = "<b>Error:</b> " + e.message;
      }
    }

    function createPhotoGrid(rows) {
      if (!rows || rows.length === 0) return "<p>No photos found.</p>";
      let gridHtml = "<div class='photo-grid'>";
      rows.forEach(item => {
        let rawPhotos = item.Photo || item.photo || [];
        if (!Array.isArray(rawPhotos)) rawPhotos = [rawPhotos];

        rawPhotos.forEach(p => {
          let url = null;
          if (typeof p === "string") {
            url = p;
          } else if (p && typeof p === "object" && p.url) {
            url = p.url;
          }
          if (url && typeof url === "string" && url.startsWith("http")) {
            gridHtml += `<img src="${url}" alt="photo" onerror="this.style.display='none'">`;
          }
        });
      });
      gridHtml += "</div>";
      return gridHtml;
    }

    function createTable(rows) {
      if (!rows || rows.length === 0) return "<p>No data found.</p>";
      let headers = Object.keys(rows[0]);
      let table = "<table border='1' cellspacing='0' cellpadding='5'><tr>";
      headers.forEach(h => { table += `<th>${h}</th>`; });
      table += "</tr>";
      rows.forEach(r => {
        table += "<tr>";
        headers.forEach(h => { table += `<td>${r[h] ?? ""}</td>`; });
        table += "</tr>";
      });
      table += "</table>";
      return table;
    }

    async function runSystemTest() {
      const resDiv = document.getElementById("result");
      resDiv.innerHTML = "Running system test...";

      try {
        const resp = await fetch("/api/query", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ test: true })
        });
        const data = await resp.json();
        resDiv.innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (e) {
        resDiv.innerHTML = "<b>Error:</b> " + e.message;
      }
    }
  </script>
</body>
</html>
