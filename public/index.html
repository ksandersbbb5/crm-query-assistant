<!DOCTYPE html>
<html>
<head>
    <title>CRM Query Assistant</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .query-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .query-box { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px; font-family: inherit; resize: vertical; }
        .query-box:focus { outline: none; border-color: #0066cc; }
        .ask-button { background: linear-gradient(135deg, #0066cc, #004499); color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: all 0.2s; }
        .ask-button:hover { background: linear-gradient(135deg, #0052a3, #003366); transform: translateY(-1px); }
        .ask-button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .test-button { background: #666; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; margin-left: 10px; transition: all 0.2s; }
        .test-button:hover { background: #555; transform: translateY(-1px); }
        .result-container { background: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #0066cc; }
        .error { color: #d73502; background: #fff5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #d73502; white-space: pre-wrap; }
        .loading { color: #666; font-style: italic; display: flex; align-items: center; gap: 10px; }
        .sql-details { margin-top: 15px; }
        .sql-query { background: #f1f3f4; padding: 12px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; overflow-x: auto; }
        .examples { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 30px; }
        .examples ul { margin: 0; padding-left: 20px; }
        .examples li { margin: 8px 0; cursor: pointer; color: #0066cc; }
        .examples li:hover { text-decoration: underline; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #0066cc; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .chart-container { position: relative; height: 400px; margin: 20px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .data-table th { background: #0066cc; color: white; padding: 12px; text-align: left; font-weight: 600; }
        .data-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f8f9fa; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .photo-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .photo-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .photo-item img { width: 100%; height: 150px; object-fit: cover; }
        .photo-info { padding: 10px; font-size: 14px; }
        .photo-info .event-name { font-weight: 600; margin-bottom: 5px; }
        .photo-info .details { color: #666; font-size: 12px; }
        .source-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .source-badge.sql { background: #e3f2fd; color: #1976d2; }
        .source-badge.airtable { background: #f3e5f5; color: #7b1fa2; }
        .test-results { background: #f1f3f4; padding: 15px; border-radius: 6px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        details summary { cursor: pointer; font-weight: 600; margin-top: 6px; }
        code { font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>CRM Query Assistant</h1>
        <p>Ask questions about your CRM data and CREM photos in natural language</p>
    </div>
    
    <div class="query-container">
        <textarea id="question" class="query-box" rows="3" placeholder="Example: What's the status of application ID 12345? or Show me photos from Vermont"></textarea>
        <div>
          <button id="askButton" class="ask-button" onclick="askQuestion()">Ask Question</button>
          <button class="test-button" onclick="runTest()">Run System Test</button>
          <button class="test-button" onclick="debugAirtable()">Debug Airtable</button>
        </div>
    </div>
    
    <div id="result"></div>
    
    <div class="examples">
        <h3>Example Questions:</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4>CRM Applications:</h4>
                <ul>
                    <li onclick="setQuestion(this)">What's the status of application ID 45874?</li>
                    <li onclick="setQuestion(this)">Show me all applications from ME with invoice total over $1000</li>
                    <li onclick="setQuestion(this)">List the top 10 cities by number of applications</li>
                    <li onclick="setQuestion(this)">Give me average invoice amount by salesperson</li>
                    <li onclick="setQuestion(this)">How many applications were rejected or denied?</li>
                </ul>
            </div>
            <div>
                <h4>CREM Photos (Airtable):</h4>
                <ul>
                    <li onclick="setQuestion(this)">Show me the past 5 photos from VT</li>
                    <li onclick="setQuestion(this)">How many photos do we have from Vermont?</li>
                    <li onclick="setQuestion(this)">Show me a bar chart of photo counts by state</li>
                    <li onclick="setQuestion(this)">Show me a table of photo counts by state</li>
                    <li onclick="setQuestion(this)">What events do we have photos from?</li>
                    <li onclick="setQuestion(this)">Show me a bar chart of photo counts by employee last name</li>
                    <li onclick="setQuestion(this)">Which employee has the most photos?</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;
        function setQuestion(el){ document.getElementById('question').value = el.textContent; }

        function processVisualizationRequest(question, data) {
            const lowerQuestion = question.toLowerCase();
            if (lowerQuestion.includes('bar chart') && lowerQuestion.includes('by state')) return createBarChartByState(data);
            if (lowerQuestion.includes('bar chart') && lowerQuestion.includes('by employee')) return createBarChartByEmployee(data);
            if (lowerQuestion.includes('table') && lowerQuestion.includes('by state')) return createTableByState(data);
            if (lowerQuestion.includes('table') && lowerQuestion.includes('by employee')) return createTableByEmployee(data);
            if (lowerQuestion.includes('show me') && lowerQuestion.includes('photo')) return createPhotoGrid(data);
            return null;
        }

        function createBarChartByState(data) {
            const stateCounts = {};
            data.forEach(item => {
                const state = item.State || item.state || 'Unknown';
                stateCounts[state] = (stateCounts[state] || 0) + 1;
            });
            const chartHtml = '<div class="chart-container"><canvas id="stateChart"></canvas></div>';
            const chartData = { labels: Object.keys(stateCounts), datasets: [{ label: 'Number of Photos', data: Object.values(stateCounts), backgroundColor: '#0066cc', borderColor: '#004499', borderWidth: 1 }] };
            return { html: chartHtml, chart: { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { title: { display: true, text: 'Photo Count by State' } } } } };
        }

        function createBarChartByEmployee(data) {
            const counts = {};
            data.forEach(item => {
                const last = item['Employee Last Name'] || 'Unknown';
                counts[last] = (counts[last] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
            const chartHtml = '<div class="chart-container"><canvas id="employeeChart"></canvas></div>';
            const chartData = { labels: sorted.map(x=>x[0]), datasets: [{ label: 'Number of Photos', data: sorted.map(x=>x[1]), backgroundColor: '#7b1fa2', borderColor: '#6a1b9a', borderWidth: 1 }] };
            return { html: chartHtml, chart: { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { title: { display: true, text: 'Photo Count by Employee Last Name (Top 10)' } } } }, chartId: 'employeeChart' };
        }

        function createTableByState(data) {
            const counts = {};
            data.forEach(item => {
                const state = item.State || item.state || 'Unknown';
                counts[state] = (counts[state] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
            let html = '<table class="data-table"><thead><tr><th>State</th><th>Photo Count</th><th>Percentage</th></tr></thead><tbody>';
            const total = data.length;
            sorted.forEach(([state, count]) => {
                const pct = ((count/total)*100).toFixed(1);
                html += `<tr><td>${state}</td><td>${count}</td><td>${pct}%</td></tr>`;
            });
            html += `</tbody></table><p><small>Total photos: ${total}</small></p>`;
            return { html };
        }

        function createTableByEmployee(data) {
            const counts = {};
            data.forEach(item => {
                const lastName = item['Employee Last Name'] || 'Unknown';
                const firstName = item['Employee First Name'] || '';
                const name = firstName ? `${lastName}, ${firstName}` : lastName;
                counts[name] = (counts[name] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
            let html = '<table class="data-table"><thead><tr><th>Employee Name</th><th>Photo Count</th><th>Percentage</th></tr></thead><tbody>';
            const total = data.length;
            sorted.forEach(([name, count]) => {
                const pct = ((count/total)*100).toFixed(1);
                html += `<tr><td>${name}</td><td>${count}</td><td>${pct}%</td></tr>`;
            });
            html += `</tbody></table><p><small>Total photos: ${total}</small></p>`;
            return { html };
        }

        // Robust photo grid (no .startsWith on unknown types)
        function createPhotoGrid(data) {
            let gridHtml = '<div class="photo-grid">';
            data.slice(0, 10).forEach(item => {
                const eventName = item['Event Name'] || item.event_name || 'Unnamed Event';
                const state = item.State || item.state || 'Unknown';
                const date = item['Date of Event'] || item.date_of_event || '';
                const employeeName = `${item['Employee First Name'] || ''} ${item['Employee Last Name'] || ''}`.trim() || 'Unknown';

                let firstUrl = null;
                let raw = item.Photo || item.photo || item.first_photo_url || null;
                if (Array.isArray(raw)) {
                    if (typeof raw[0] === 'string') firstUrl = raw[0];
                    else if (raw[0] && typeof raw[0] === 'object' && typeof raw[0].url === 'string') firstUrl = raw[0].url;
                } else if (typeof raw === 'string') {
                    firstUrl = raw;
                } else if (raw && typeof raw === 'object' && typeof raw.url === 'string') {
                    firstUrl = raw.url;
                }

                gridHtml += `<div class="photo-item">`;
                if (firstUrl) {
                    gridHtml += `<img src="${firstUrl}" alt="${eventName}" onerror="this.style.display='none'">`;
                }
                gridHtml += `
                    <div class="photo-info">
                        <div class="event-name">${eventName}</div>
                        <div class="details">
                            ${state} • ${date ? new Date(date).toLocaleDateString() : 'No date'}
                            <br>Submitted by: ${employeeName}
                        </div>
                    </div>
                </div>`;
            });
            gridHtml += '</div>';
            if (data.length > 10) gridHtml += `<p><small>Showing first 10 of ${data.length} photos</small></p>`;
            return { html: gridHtml };
        }

        async function askQuestion() {
            const q = document.getElementById('question').value;
            const resultDiv = document.getElementById('result');
            const askButton = document.getElementById('askButton');
            if (!q.trim()) { alert('Please enter a question'); return; }
            if (currentChart) { currentChart.destroy(); currentChart = null; }

            askButton.disabled = true; askButton.textContent = 'Processing...';
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div>Processing your question...</div>`;

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: q })
                });
                const data = await response.json();

                if (response.status === 401) {
                    resultDiv.innerHTML = `<div class="error"><strong>Error:</strong> Unauthorized Access</div>`;
                } else if (data.error) {
                    let traceBlock = data.trace ? `<details><summary>Show technical details</summary><code>${escapeHtml(data.trace)}</code></details>` : '';
                    let contextBlock = data.context ? `<br><small>Context: <code>${escapeHtml(JSON.stringify(data.context))}</code></small>` : '';
                    resultDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${data.error}${contextBlock}${traceBlock}</div>`;
                } else {
                    const viz = data.raw_results ? processVisualizationRequest(q, data.raw_results) : null;
                    const sourceBadge = data.query_type === 'airtable' ? '<span class="source-badge airtable">Airtable</span>' : '<span class="source-badge sql">SQL Server</span>';
                    let html = `<div class="result-container"><h3>Answer: ${sourceBadge}</h3>`;
                    if (viz) {
                        html += viz.html;
                        if (viz.chart) {
                            setTimeout(() => {
                                const chartId = viz.chartId || 'stateChart';
                                const ctx = document.getElementById(chartId).getContext('2d');
                                currentChart = new Chart(ctx, viz.chart);
                            }, 100);
                        }
                    } else {
                        html += `<p>${data.answer}</p>`;
                    }
                    html += `${data.results_count ? `<br/><small><em>Found ${data.results_count} records</em></small>` : ''}`;
                    html += `<details class="sql-details"><summary style="cursor:pointer;margin-top:10px;">View Generated Query</summary><div class="sql-query">${data.sql || 'N/A'}</div></details></div>`;
                    resultDiv.innerHTML = html;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error"><strong>Network Error:</strong> ${e.message}</div>`;
            } finally {
                askButton.disabled = false; askButton.textContent = 'Ask Question';
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        async function runTest() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div>Running system test...</div>`;
            try {
                const response = await fetch('/api/query', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ test: true }) });
                const text = await response.text();
                try {
                    const data = JSON.parse(text);
                    resultDiv.innerHTML = `<div class="result-container"><h3>System Configuration Test Results:</h3><div class="test-results">${JSON.stringify(data, null, 2)}</div></div>`;
                } catch {
                    resultDiv.innerHTML = `<div class="error"><strong>Server Error:</strong><pre>${text}</pre></div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error"><strong>Network Error:</strong> ${e.message}</div>`;
            }
        }

        async function debugAirtable() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div>Debugging Airtable...</div>`;
            try {
                const response = await fetch('/api/query', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ test: true, debug: 'airtable' }) });
                const data = await response.json();
                resultDiv.innerHTML = `<div class="result-container"><h3>Airtable Debug:</h3><div class="test-results">${JSON.stringify(data, null, 2)}</div></div>`;
            } catch (e) {
                resultDiv.innerHTML = `<div class="error"><strong>Network Error:</strong> ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
